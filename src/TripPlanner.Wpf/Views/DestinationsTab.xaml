<UserControl x:Class="TripPlanner.Wpf.Views.DestinationsTab"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:TripPlanner.Wpf.Converters">
  <UserControl.Resources>
    <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    <conv:StringToImageSourceConverter x:Key="StringToImg"/>
    <conv:BooleanNegationConverter x:Key="NotBool"/>
    <Style x:Key="Card" TargetType="Border">
      <Setter Property="Width" Value="340"/>
      <Setter Property="Margin" Value="10"/>
      <Setter Property="Padding" Value="10"/>
      <Setter Property="CornerRadius" Value="12"/>
      <Setter Property="Background" Value="{DynamicResource {x:Static SystemColors.ControlLightBrushKey}}"/>
      <Setter Property="Effect">
        <Setter.Value>
          <DropShadowEffect ShadowDepth="2" BlurRadius="8" Opacity="0.15"/>
        </Setter.Value>
      </Setter>
    </Style>
    <Style x:Key="MutedButton" TargetType="Button">
      <Setter Property="Padding" Value="6,4"/>
      <Setter Property="MinWidth" Value="72"/>
    </Style>
  </UserControl.Resources>

  <DockPanel Margin="8">

    <!-- Top bar -->
    <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,8">
      <TextBlock Text="Vote as:" VerticalAlignment="Center" Margin="0,0,8,0"/>
      <ComboBox Width="280" ItemsSource="{Binding VoterOptions}" SelectedItem="{Binding SelectedVoter}" />
      <Button Content="＋" FontSize="18" Width="36" Height="32" Margin="12,0,0,0"
              ToolTip="Propose destination" Command="{Binding AddNewCommand}"/>
    </StackPanel>

    <!-- Horizontal scroller with wrap -->
    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled" PanningMode="HorizontalOnly">
      <ItemsControl ItemsSource="{Binding Items}">
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate>
            <WrapPanel Orientation="Horizontal" IsItemsHost="True"/>
          </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>

        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <Border Style="{StaticResource Card}">
              <Grid>
                <!-- NORMAL CARD -->
                <Grid x:Name="Normal" Visibility="Visible">
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="200"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                  </Grid.RowDefinitions>

                  <!-- Title + overlay edit -->
                  <Grid Grid.Row="0" Margin="0,0,0,8">
                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center"/>
                    <Button Content="✎" Width="28" Height="24"
                            HorizontalAlignment="Right" VerticalAlignment="Top"
                            Style="{StaticResource MutedButton}"
                            Command="{Binding DataContext.EditCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding}"
                            ToolTip="Edit / Delete"/>
                  </Grid>

                  <!-- Image -->
                  <Border Grid.Row="1" CornerRadius="8" Background="#FFF" BorderBrush="#DDD" BorderThickness="1">
                    <Image Stretch="UniformToFill">
                      <Image.Source>
                        <Binding Path="ImageUrl" Converter="{StaticResource StringToImg}"/>
                      </Image.Source>
                    </Image>
                  </Border>

                  <!-- Description -->
                  <TextBlock Grid.Row="2" Text="{Binding Description}" TextWrapping="Wrap" Opacity="0.9" Margin="0,8,0,6"/>

                  <!-- Votes + button -->
                  <DockPanel Grid.Row="3" LastChildFill="True">
                    <TextBlock Text="{Binding VoteCount, StringFormat=Votes: {0}}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <Button Content="Vote" Style="{StaticResource MutedButton}"
                            HorizontalAlignment="Stretch"
                            IsEnabled="{Binding IsSelectedVoterVoted, Converter={StaticResource NotBool}}"
                            Command="{Binding DataContext.ToggleVoteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding}"/>
                  </DockPanel>
                </Grid>

                <!-- ADD CARD -->
                <Grid x:Name="AddCard" Visibility="Collapsed">
                  <Button Content="＋" FontSize="48"
                          HorizontalAlignment="Center" VerticalAlignment="Center"
                          ToolTip="Propose destination"
                          Command="{Binding DataContext.AddNewCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                </Grid>

                <!-- Visual accents -->
                <Border CornerRadius="12" BorderBrush="#2D7D46" BorderThickness="2" IsHitTestVisible="False"
                        Visibility="{Binding IsSelectedVoterVoted, Converter={StaticResource BoolToVis}}"/>
                <Border CornerRadius="12" Background="#FFF4C2" Opacity="0.55" IsHitTestVisible="False"
                        Visibility="{Binding IsMostVoted, Converter={StaticResource BoolToVis}}"/>
              </Grid>

              <!-- Switch normal vs add -->
            </Border>
            <DataTemplate.Triggers>
              <DataTrigger Binding="{Binding IsAddNew}" Value="True">
                <Setter TargetName="Normal" Property="Visibility" Value="Collapsed"/>
                <Setter TargetName="AddCard" Property="Visibility" Value="Visible"/>
              </DataTrigger>
            </DataTemplate.Triggers>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </ScrollViewer>
  </DockPanel>
</UserControl>
