<UserControl x:Class="TripPlanner.Wpf.Views.GearTab"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <UserControl.Resources>
    <!-- Group items by Group -->
    <CollectionViewSource x:Key="GroupedItems" Source="{Binding Items}">
      <CollectionViewSource.GroupDescriptions>
        <PropertyGroupDescription PropertyName="Group"/>
      </CollectionViewSource.GroupDescriptions>
      <CollectionViewSource.SortDescriptions>
        <componentModel:SortDescription PropertyName="Group" Direction="Ascending" xmlns:componentModel="clr-namespace:System.ComponentModel;assembly=WindowsBase"/>
        <componentModel:SortDescription PropertyName="Name" Direction="Ascending" xmlns:componentModel="clr-namespace:System.ComponentModel;assembly=WindowsBase"/>
      </CollectionViewSource.SortDescriptions>
    </CollectionViewSource>

    <!-- Simple capsule header -->
    <Style x:Key="GroupHeader" TargetType="Border">
      <Setter Property="Background" Value="#FFEFEFEF"/>
      <Setter Property="CornerRadius" Value="8"/>
      <Setter Property="Padding" Value="8"/>
      <Setter Property="Margin" Value="0,16,0,8"/>
    </Style>

    <!-- One-line row -->
    <Style x:Key="RowCard" TargetType="Border">
      <Setter Property="CornerRadius" Value="6"/>
      <Setter Property="Padding" Value="6"/>
      <Setter Property="BorderBrush" Value="#DDDDDD"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="Margin" Value="0,4,0,4"/>
      <Setter Property="SnapsToDevicePixels" Value="True"/>
    </Style>
  </UserControl.Resources>

  <!-- IMPORTANT: enable shared sizing for header + rows -->
  <DockPanel Margin="8" Grid.IsSharedSizeScope="True">

    <!-- Top bar: create item -->
    <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" VerticalAlignment="Top" Margin="0,0,0,12">
      <TextBlock Text="Provisioning" VerticalAlignment="Center" Opacity="0.6"/>
      <ComboBox Width="140" Margin="8,0,0,0" SelectedIndex="{Binding NewProvisioning}">
        <ComboBoxItem Content="Per person"/>
        <ComboBoxItem Content="Shared"/>
      </ComboBox>

      <TextBlock Text="Group" Margin="16,0,0,0" VerticalAlignment="Center" Opacity="0.6"/>
      <TextBox Width="140" Margin="8,0,0,0" Text="{Binding NewGroup, UpdateSourceTrigger=PropertyChanged}"/>

      <TextBlock Text="Item" Margin="16,0,0,0" VerticalAlignment="Center" Opacity="0.6"/>
      <TextBox Width="200" Margin="8,0,0,0" Text="{Binding NewName, UpdateSourceTrigger=PropertyChanged}"/>

      <TextBlock Text="Needed" Margin="16,0,0,0" VerticalAlignment="Center" Opacity="0.6"/>
      <!-- Enabled only for Shared -->
      <TextBox Width="80" Margin="8,0,0,0"
               IsEnabled="{Binding NewProvisioning, Converter={StaticResource BooleanWhenEqualsOneConverter}, ConverterParameter=1}"
               Text="{Binding NewNeededQty, UpdateSourceTrigger=PropertyChanged}"/>

      <Button Content="Add item" Margin="12,0,0,0" Padding="12,6"
              Command="{Binding CreateCommand}"/>
      <Button Content="Camping preset" Margin="8,0,0,0" Padding="12,6"
              Command="{Binding BulkCreateCampingPresetCommand}"/>
    </StackPanel>

    <!-- Column headers (use SharedSizeGroup to align with rows) -->
    <Grid DockPanel.Dock="Top" Margin="0,0,0,6">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>                         <!-- Item (fills left) -->
        <ColumnDefinition Width="110" SharedSizeGroup="c1"/>  <!-- Provisioning -->
        <ColumnDefinition Width="80"  SharedSizeGroup="c2"/>  <!-- Needed -->
        <ColumnDefinition Width="80"  SharedSizeGroup="c3"/>  <!-- Claimed -->
        <ColumnDefinition Width="80"  SharedSizeGroup="c4"/>  <!-- Left -->
        <ColumnDefinition Width="Auto" SharedSizeGroup="c5"/> <!-- My claim -->
        <ColumnDefinition Width="Auto" SharedSizeGroup="c6"/> <!-- Delete -->
      </Grid.ColumnDefinitions>

      <TextBlock Grid.Column="0" Text="Item"          Opacity="0.6"/>
      <TextBlock Grid.Column="1" Text="Provisioning"  Opacity="0.6" Margin="12,0,0,0"/>
      <TextBlock Grid.Column="2" Text="Needed"        Opacity="0.6"/>
      <TextBlock Grid.Column="3" Text="Claimed"       Opacity="0.6"/>
      <TextBlock Grid.Column="4" Text="Left"          Opacity="0.6"/>
      <TextBlock Grid.Column="5" Text="My claim"      Opacity="0.6"/>
      <!-- column 6 intentionally blank -->
    </Grid>

    <!-- Groups + rows (scrollable body) -->
    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
      <ItemsControl ItemsSource="{Binding Source={StaticResource GroupedItems}}"
                    ScrollViewer.CanContentScroll="True">
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate>
            <VirtualizingStackPanel/>
          </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>

        <ItemsControl.GroupStyle>
          <GroupStyle>
            <GroupStyle.HeaderTemplate>
              <DataTemplate>
                <Border Style="{StaticResource GroupHeader}">
                  <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                </Border>
              </DataTemplate>
            </GroupStyle.HeaderTemplate>
          </GroupStyle>
        </ItemsControl.GroupStyle>

        <!-- Stretch rows to full width so columns match header -->
        <ItemsControl.ItemContainerStyle>
          <Style TargetType="ContentPresenter">
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
          </Style>
        </ItemsControl.ItemContainerStyle>

        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <Border Style="{StaticResource RowCard}">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>                         <!-- Item (fills left) -->
                  <ColumnDefinition Width="110" SharedSizeGroup="c1"/>
                  <ColumnDefinition Width="80"  SharedSizeGroup="c2"/>
                  <ColumnDefinition Width="80"  SharedSizeGroup="c3"/>
                  <ColumnDefinition Width="80"  SharedSizeGroup="c4"/>
                  <ColumnDefinition Width="Auto" SharedSizeGroup="c5"/>
                  <ColumnDefinition Width="Auto" SharedSizeGroup="c6"/>
                </Grid.ColumnDefinitions>

                <!-- Name -->
                <TextBlock Grid.Column="0" Text="{Binding Name}" VerticalAlignment="Center"/>

                <!-- Provisioning -->
                <TextBlock Grid.Column="1" Margin="12,0,0,0"
                           VerticalAlignment="Center"
                           Text="{Binding Provisioning, Converter={StaticResource GearProvisioningToTextConverter}}"/>

                <!-- Needed / Claimed / Left -->
                <TextBlock Grid.Column="2" VerticalAlignment="Center" Text="{Binding NeededTotal}"/>
                <TextBlock Grid.Column="3" VerticalAlignment="Center" Text="{Binding ClaimedTotal}"/>
                <TextBlock Grid.Column="4" VerticalAlignment="Center" Text="{Binding LeftTotal}"/>

                <!-- My claim editor -->
                <StackPanel Grid.Column="5" Orientation="Horizontal" HorizontalAlignment="Right">
                  <TextBox Width="48" HorizontalContentAlignment="Center"
                           Text="{Binding MyClaim, UpdateSourceTrigger=PropertyChanged}"/>
                  <Button Content="Save" Padding="12,4" Margin="6,0,0,0"
                          Command="{Binding DataContext.SaveClaimCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                          CommandParameter="{Binding}"/>
                  <Button Content="Delete" Padding="12,4" Margin="6,0,0,0"
                          Command="{Binding DataContext.DeleteClaimCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                          CommandParameter="{Binding}"/>
                </StackPanel>

                <!-- Delete item -->
                <Button Grid.Column="6" Content="✕" Padding="6,2" Margin="8,0,0,0"
                        ToolTip="Delete item"
                        Command="{Binding DataContext.DeleteItemCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                        CommandParameter="{Binding}"/>
              </Grid>
            </Border>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </ScrollViewer>

  </DockPanel>
</UserControl>
